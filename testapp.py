import os
import time
import requests
import re
from bs4 import BeautifulSoup
import google.generativeai as genai
from google.api_core import exceptions

# =============================================================================
# ⚙️ ΡΥΘΜΙΣΕΙΣ ΧΡΗΣΤΗ
# =============================================================================
GOOGLE_API_KEY = "TO_API_KEY_SOY_EDO"  # <--- ΒΑΛΕ ΤΟ ΚΛΕΙΔΙ ΣΟΥ ΕΔΩ
DOWNLOAD_FOLDER = "nomosxedio_downloads"

# Ορίζουμε το "Super-Prompt" του Αυστηρού Ελεγκτή
SYSTEM_INSTRUCTIONS = """
Ενεργείς ως Ανώτατος Νομικός Ελεγκτής (Legal Auditor) και Γλωσσολόγος.
Σου δίνονται κείμενα νομοθεσίας, εκθέσεις και στοιχεία διαβούλευσης.
Η αποστολή σου είναι ο ΕΛΕΓΧΟΣ ΠΟΙΟΤΗΤΑΣ ΚΑΙ ΝΟΜΙΜΟΤΗΤΑΣ.

--- ΔΟΜΗ ΤΗΣ ΕΚΘΕΣΗΣ ΕΛΕΓΧΟΥ (AUDIT REPORT) ---

### 1. 📋 ΕΛΕΓΧΟΣ ΔΙΑΔΙΚΑΣΙΑΣ (CHECKLIST ΚΑΛΗΣ ΝΟΜΟΘΕΤΗΣΗΣ)
Απάντησε ΑΥΣΤΗΡΑ με [ΝΑΙ / ΟΧΙ / ΜΕΡΙΚΩΣ] και τεκμηρίωση:
Η αποστολή σου είναι να συντάξεις την **ΕΚΘΕΣΗ ΑΞΙΟΛΟΓΗΣΗΣ ΚΑΛΗΣ ΝΟΜΟΘΕΤΗΣΗΣ** απαντώντας ΑΥΣΤΗΡΑ στα παρακάτω ερωτήματα του Δεκαλόγου.

--- Ο ΔΕΚΑΛΟΓΟΣ ΤΗΣ ΚΑΛΗΣ ΝΟΜΟΘΕΤΗΣΗΣ ---
Για κάθε ερώτημα απάντησε με: [ΝΑΙ / ΟΧΙ / ΜΕΡΙΚΩΣ / ΔΕΝ ΠΡΟΚΥΠΤΕΙ] και μια σύντομη, αιχμηρή τεκμηρίωση.

1. Έγινε προ-κοινοβουλευτική διαβούλευση;
   - [ΝΑΙ/ΟΧΙ]
   1.1.1. Εάν ναι, διήρκεσε ΠΕΡΙΣΣΟΤΕΡΟ ή ΛΙΓΟΤΕΡΟ από 14 ημέρες; (Έλεγξε τις ημερομηνίες που σου δίνονται).
   1.2. Παρουσιάστηκαν τα ευρήματα της διαβούλευσης με τρόπο πλήρη και κατανοητό σε ξεχωριστή έκθεση που συνόδευε το νομοσχέδιο; (Έλεγξε αν υπάρχει η Έκθεση Διαβούλευσης και αν αναλύει τα σχόλια ή είναι τυπική).

2. Ο μέσος χρόνος που δόθηκε στην ακρόαση φορέων σε καθέναν υπερβαίνει τα 5 λεπτά;
   - (Αναζήτησε ενδείξεις στα κείμενα ή στα στοιχεία που σου δίνονται από το internet για τα πρακτικά).

3. Συγκρίνοντας το αρχικό σχέδιο νόμου με εκείνο που εισήχθη στην ολομέλεια, υπάρχουν διατάξεις που εμφανίστηκαν για πρώτη φορά με την μορφή (πολύ-) τροπολογιών;
   - (Εντόπισε άρθρα στο τέλος του νόμου, π.χ. "Λοιπές ρυθμίσεις", που δεν υπήρχαν στο αρχικό ή είναι άσχετα με τον τίτλο).

4. Υπάρχει «επιχρύσωση» (gold-plating);
   - (Προσθήκη άσχετων διατάξεων εθνικού ενδιαφέροντος σε κυρώσεις διεθνών συμβάσεων/ΕΕ).

5. Υπάρχουν ειδικές διατάξεις που αφορούν τους ορεινούς όγκους και τα νησιά (Ρήτρα Νησιωτικότητας);
   - (Έλεγξε αν υπάρχει ειδική μέριμνα ή αν αγνοείται η γεωγραφική ιδιαιτερότητα).

6. Υπάρχει τεκμηριωμένη ανάλυση κόστους-ωφέλειας στην ανάλυση επιπτώσεων;
   - (ΠΡΟΣΟΧΗ: Υπάρχουν ποσοτικά στοιχεία/νούμερα για το ΟΦΕΛΟΣ; Το κόστος συνήθως υπάρχει στην έκθεση ΓΛΚ. Το όφελος μετριέται;)

7. Υπάρχουν διατάξεις που απλουστεύουν/καταργούν προηγούμενες και ιδίως εκείνες που προκαλούν διοικητικές επιβαρύνσεις;
   - (Γίνεται προσπάθεια μείωσης γραφειοκρατίας ή προστίθενται νέα στάδια/δικαιολογητικά;)

8. Υπάρχουν εξουσιοδοτήσεις για την έκδοση Υπουργικών Αποφάσεων για θέματα του κυρίως αντικειμένου του νομοσχεδίου;
   - (Μέτρα πόσες φορές αναφέρεται "Με απόφαση του Υπουργού...". Αν αφορούν την ουσία του νόμου, είναι ΑΡΝΗΤΙΚΟ).

9. Αναφέρονται ειδικότεροι μηχανισμοί εφαρμογής όσων διαλαμβάνει ο νόμος;
   - (Υπάρχει χρονοδιάγραμμα; Υπάρχει ψηφιακή πλατφόρμα; Ποιος ελέγχει την εφαρμογή;)

10. Υπάρχουν δυσκολίες στην κατανόηση του νόμου (συντακτικά λάθη, αρτικόλεξα, δυσνόητες έννοιες);
    - (Κάνε γλωσσικό έλεγχο. Εντόπισε μακροπερίοδο λόγο, αοριστίες, ή ξύλινη γλώσσα όπως "εν γένει", "κατ' εξαίρεση", "βέλτιστη πρακτική").

--- ΤΕΛΙΚΗ ΒΑΘΜΟΛΟΓΙΑ ---
Δώσε βαθμό (0-10) για την ποιότητα νομοθέτησης και σύνοψη.
* **Διαβούλευση:** Διήρκεσε >14 ημέρες; (Δες ημερομηνίες Opengov). Ελήφθησαν υπόψη τα σχόλια;
* **Ακρόαση Φορέων:** Υπήρξε ουσιαστικός χρόνος στη Βουλή ή ήταν τυπική;
* **"Επιχρύσωση" (Gold-plating):** Προστέθηκαν εθνικά βάρη σε ευρωπαϊκές οδηγίες;
* **Άσχετες Τροπολογίες:** Υπάρχουν "άσχετες" ή "φωτογραφικές" διατάξεις (συνήθως στο τέλος του νόμου);
* **Ανάλυση Κόστους-Ωφέλειας:** Υπάρχουν ποσοτικά στοιχεία (αριθμοί/ευρώ) για το ΟΦΕΛΟΣ ή μόνο αερολογίες;

### 2. ⚖️ ΕΛΕΓΧΟΣ ΠΕΡΙΕΧΟΜΕΝΟΥ (DEEP DIVE)
* **Φαινόμενο "Λευκής Επιταγής":** Κατάγραψε πόσες φορές ανατίθεται σε Υπουργό να αποφασίσει τα σημαντικά (π.χ. "καθορίζονται οι όροι, οι προϋποθέσεις..."). Είναι κρίσιμα θέματα;
* **Διοικητικό Βάρος (Red Tape):** Εντόπισε διαδικασίες που απαιτούν υπερβολική χαρτούρα/χρόνο από τον πολίτη/υπάλληλο.
* **Αρχή Αναγκαιότητας:** Τεκμηριώνεται γιατί χρειάζεται ΝΕΟΣ νόμος και όχι τροποποίηση του παλιού;

### 3. 🔍 ΓΛΩΣΣΙΚΟΣ & ΝΟΜΟΤΕΧΝΙΚΟΣ ΕΛΕΓΧΟΣ
* **"Ξύλινη Γλώσσα":** Εντόπισε αόριστους όρους management (π.χ. "βέλτιστη", "εξορθολογισμός", "καινοτομία") χωρίς νομικό ορισμό.
* **Πολυνομία/Λαβύρινθος:** Εντόπισε αλυσίδες παραπομπών (π.χ. "άρθρο Χ του ν.Ψ όπως τροποποιήθηκε με το Ζ").
* **Συντακτική Πολυπλοκότητα:** Εντόπισε προτάσεις άνω των 50 λέξεων που κουράζουν.

### 4. 📝 ΤΕΛΙΚΟ ΠΟΡΙΣΜΑ
Βαθμολόγησε (0-10) και δώσε 3 συγκεκριμένες συστάσεις.
"""

# =============================================================================
# 🛠️ ΕΡΓΑΛΕΙΑ (SCRAPING & SEARCH)
# =============================================================================

def google_search_opengov(law_number_or_title):
    """Ψάχνει στο Google για τη διαβούλευση στο Opengov."""
    print(f"🔎 Αναζήτηση διαβούλευσης για: {law_number_or_title}...")
    # Εδώ κάνουμε μια "ψευδο-αναζήτηση" για το παράδειγμα. 
    # Στην πραγματικότητα, για να ψάξεις το Google θες το Custom Search API ή scraping (που συχνά μπλοκάρεται).
    # Θα χρησιμοποιήσουμε μια τεχνική scraping στο Google Search results (προσοχή: μπορεί να μπλοκαριστεί).
    
    query = f"site:opengov.gr {law_number_or_title} διαβούλευση"
    url = f"https://www.google.com/search?q={query}"
    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0 Safari/537.36'}
    
    try:
        res = requests.get(url, headers=headers)
        soup = BeautifulSoup(res.text, 'html.parser')
        # Προσπάθεια εύρεσης συνδέσμου opengov
        links = []
        for a in soup.find_all('a', href=True):
            if 'opengov.gr' in a['href']:
                clean_link = a['href'].split('&')[0].replace('/url?q=', '')
                if clean_link not in links:
                    links.append(clean_link)
        
        if links:
            print(f"   Βρέθηκε πιθανό link διαβούλευσης: {links[0]}")
            return links[0]
        else:
            print("   Δεν βρέθηκε link στο Opengov.")
            return None
    except Exception as e:
        print(f"⚠️ Σφάλμα αναζήτησης: {e}")
        return None

def fetch_opengov_content(url):
    """Κατεβάζει το κείμενο από τη σελίδα του Opengov."""
    if not url: return ""
    try:
        headers = {'User-Agent': 'Mozilla/5.0'}
        res = requests.get(url, headers=headers, timeout=10)
        soup = BeautifulSoup(res.content, 'html.parser')
        
        # Προσπάθεια εύρεσης ημερομηνιών
        text = soup.get_text(separator=' ', strip=True)
        return text[:20000] # Επιστρέφουμε τους πρώτους 20k χαρακτήρες (συνήθως εκεί είναι οι ημερομηνίες)
    except:
        return ""

def download_parliament_documents(law_id_or_url):
    """
    (Προαιρετικό) Εδώ θα μπορούσε να μπει κώδικας που κατεβάζει PDF από τη Βουλή.
    Επειδή το site της Βουλής είναι δύσκολο στο scraping, θα υποθέσουμε ότι 
    ο χρήστης έχει βάλει τα αρχεία στον φάκελο, ή δίνει direct links.
    """
    # Για την οικονομία του κώδικα, ελέγχουμε τον τοπικό φάκελο.
    if not os.path.exists(DOWNLOAD_FOLDER):
        os.makedirs(DOWNLOAD_FOLDER)
    
    files = [os.path.join(DOWNLOAD_FOLDER, f) for f in os.listdir(DOWNLOAD_FOLDER) if f.endswith('.pdf')]
    return files

# =============================================================================
# 🧠 AI PROCESSING (GEMINI)
# =============================================================================

def analyze_with_gemini(files, opengov_text, law_title):
    genai.configure(api_key=GOOGLE_API_KEY)
    
    # Upload Files
    uploaded_files = []
    print(f"📤 Ανέβασμα {len(files)} αρχείων στο AI...")
    for file_path in files:
        print(f"   ... {os.path.basename(file_path)}")
        uf = genai.upload_file(file_path, mime_type="application/pdf")
        uploaded_files.append(uf)

    # Wait for Processing (OCR)
    print("⏳ Το AI μελετά τα έγγραφα (OCR & Parsing)...")
    while True:
        if all(f.state.name == "ACTIVE" for f in [genai.get_file(uf.name) for uf in uploaded_files]):
            break
        print(".", end="", flush=True)
        time.sleep(2)
    print("\n✅ Έτοιμο για ανάλυση.")

    # Model Setup
    model = genai.GenerativeModel(model_name="gemini-1.5-pro", system_instruction=SYSTEM_INSTRUCTIONS)

    # Context Prompt
    context_prompt = f"""
    Αντικείμενο Ελέγχου: {law_title}
    
    --- ΣΤΟΙΧΕΙΑ ΑΠΟ ΔΙΑΒΟΥΛΕΥΣΗ (OPENGOV) ---
    {opengov_text}
    
    --- ΕΝΤΟΛΗ ---
    Προχώρα στον πλήρη έλεγχο των επισυναπτόμενων αρχείων PDF σε συνδυασμό με τα παραπάνω στοιχεία διαβούλευσης.
    Εφάρμοσε αυστηρά τον "Δεκάλογο" και το "Εγχειρίδιο Νομοπαρασκευαστικής Μεθοδολογίας".
    """

    try:
        response = model.generate_content(
            uploaded_files + [context_prompt],
            request_options={"timeout": 600}
        )
        return response.text
    except Exception as e:
        return f"❌ Σφάλμα κατά την ανάλυση AI: {e}"

# =============================================================================
# 🚀 MAIN PROGRAM
# =============================================================================

def main():
    print("="*60)
    print("🏛️  AI LEGAL AUDITOR - GREEK LEGISLATION  🏛️")
    print("="*60)
    
    law_input = input("👉 Δώσε Αριθμό Νόμου ή Τίτλο (π.χ. 4940/2022): ").strip()
    parliament_url = input("👉 (Προαιρετικά) Link Βουλής: ").strip()

    # 1. Ψάχνουμε Διαβούλευση
    opengov_url = google_search_opengov(law_input)
    opengov_data = ""
    if opengov_url:
        print(f"   Λήψη δεδομένων από: {opengov_url}")
        opengov_data = fetch_opengov_content(opengov_url)
    else:
        print("⚠️ Δεν βρέθηκαν δεδομένα διαβούλευσης αυτόματα.")

    # 2. Εντοπισμός Αρχείων PDF
    # Εδώ υποθέτουμε ότι τα έχεις ήδη κατεβάσει στον φάκελο, 
    # ή θα μπορούσε να μπει script που τα κατεβάζει από το Link της Βουλής.
    pdf_files = download_parliament_documents(parliament_url)
    
    if not pdf_files:
        print(f"❌ Δεν βρέθηκαν PDF στον φάκελο '{DOWNLOAD_FOLDER}'.")
        print("   Παρακαλώ κατέβασε τα PDF (Νόμο, Εκθέσεις) σε αυτόν τον φάκελο και ξανατρέξε το.")
        return

    # 3. Εκτέλεση Ελέγχου
    audit_result = analyze_with_gemini(pdf_files, opengov_data, law_input)

    # 4. Αποτέλεσμα
    print("\n" + "="*60)
    print("📋  ΠΟΡΙΣΜΑ ΕΛΕΓΧΟΥ  📋")
    print("="*60)
    print(audit_result)
    
    # Αποθήκευση
    with open(f"Audit_Report_{law_input.replace('/','-')}.txt", "w", encoding="utf-8") as f:
        f.write(audit_result)
    print(f"\n✅ Η έκθεση αποθηκεύτηκε στο αρχείο txt.")

if __name__ == "__main__":
    main()

